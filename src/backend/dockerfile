# ----------------------------------
# Stage 1: prepare ffmpeg
# ----------------------------------
FROM python:3.13-slim AS ffmpeg

USER root

RUN apt-get update && apt-get install -y \
  ffmpeg \
  && rm -rf /var/lib/apt/lists/*

# ----------------------------------
# Stage 2: install Python dependencies
# ----------------------------------
FROM python:3.13-slim AS deps

WORKDIR /autumn

USER root

COPY src/backend/requirements.txt src/backend/requirements.txt

RUN pip install --upgrade pip setuptools wheel
RUN pip install --no-cache-dir -r src/backend/requirements.txt

# ----------------------------------
# Stage 3: final image
# ----------------------------------
FROM python:3.13-slim

WORKDIR /autumn

USER root

COPY --from=deps /usr/local/lib/python3.13/site-packages /usr/local/lib/python3.13/site-packages
COPY --from=deps /usr/local/bin /usr/local/bin
COPY --from=ffmpeg /usr/bin/ffmpeg /usr/bin/ffmpeg

RUN mkdir -p /root/.cache/huggingface && chmod 777 /root/.cache/huggingface
RUN python -c "from huggingface_hub import snapshot_download; snapshot_download(repo_id='mobiuslabsgmbh/faster-whisper-large-v3-turbo')"

COPY src/backend ./src/backend